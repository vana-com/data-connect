<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign in - Vana Passport</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .container {
      width: 100%;
      max-width: 520px;
      background: white;
      border-radius: 16px;
      padding: 48px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .vana-logo {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a1a;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      line-height: 1.3;
      margin-bottom: 12px;
    }

    .header h1 .accent {
      color: #4f46e5;
    }

    .header p {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 28px;
    }

    .error {
      padding: 12px;
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      color: #dc2626;
      display: none;
    }

    /* Email input row */
    .email-row {
      display: flex;
      align-items: center;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 4px 4px 4px 16px;
      margin-bottom: 12px;
      transition: border-color 0.15s;
    }

    .email-row:focus-within {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.08);
    }

    .email-row .mail-icon {
      color: #9ca3af;
      flex-shrink: 0;
      margin-right: 12px;
    }

    .email-row input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 15px;
      color: #1a1a1a;
      background: transparent;
      padding: 10px 0;
    }

    .email-row input::placeholder { color: #9ca3af; }

    .email-row .submit-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: none;
      background-color: #4f46e5;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background-color 0.15s;
    }

    .email-row .submit-btn:hover { background-color: #4338ca; }
    .email-row .submit-btn:disabled { background-color: #c7d2fe; cursor: not-allowed; }

    /* OAuth buttons */
    .oauth-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
      font-weight: 500;
      color: #1a1a1a;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 8px;
    }

    .oauth-btn:hover:not(:disabled) {
      background-color: #f9fafb;
      border-color: #d1d5db;
    }

    .oauth-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .oauth-btn .badge {
      margin-left: auto;
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    /* Code input section */
    .code-section { margin-top: 16px; }

    .code-section label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }

    .code-section input {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      color: #1a1a1a;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      outline: none;
      text-align: center;
      letter-spacing: 6px;
      margin-bottom: 12px;
    }

    .code-section input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.08);
    }

    .verify-btn {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      font-weight: 500;
      color: white;
      background-color: #4f46e5;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.15s;
    }

    .verify-btn:hover:not(:disabled) { background-color: #4338ca; }
    .verify-btn:disabled { background-color: #c7d2fe; cursor: not-allowed; }

    /* Footer */
    .footer {
      margin-top: 24px;
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
      line-height: 1.5;
    }

    .footer a {
      color: #6b7280;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .footer a:hover { color: #374151; }

    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e5e7eb;
      border-top-color: #4f46e5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading p {
      margin-top: 16px;
      color: #6b7280;
      font-size: 14px;
    }

    /* Success */
    .success {
      text-align: center;
      padding: 24px;
    }

    .success-icon {
      width: 64px;
      height: 64px;
      background-color: #dcfce7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .success-icon svg { width: 32px; height: 32px; color: #22c55e; }

    .success h2 {
      font-size: 22px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 12px;
    }

    .success p { font-size: 14px; color: #6b7280; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p id="loading-text">Initializing...</p>
    </div>

    <!-- Login Form -->
    <div id="login-form" class="hidden">
      <div class="header">
        <div class="vana-logo">vana</div>
        <h1><span class="accent">Data Connect uses Vana Passport</span><br>to bring your data everywhere</h1>
        <p>Sign-in or create your Vana Passport to grant permissions.</p>
      </div>

      <div id="error" class="error"></div>

      <div id="privy-container"></div>
    </div>

    <!-- Success State -->
    <div id="success" class="hidden">
      <div class="success">
        <div class="success-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <h2>You're signed in!</h2>
        <p>You can close this window and return to the app.</p>
      </div>
    </div>
  </div>

  <script type="module">
    const PRIVY_APP_ID = '{{PRIVY_APP_ID}}';
    const PRIVY_CLIENT_ID = '{{PRIVY_CLIENT_ID}}';

    function showLoading(message = 'Loading...') {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('loading-text').textContent = message;
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('success').classList.add('hidden');
    }

    function showLoginForm() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('success').classList.add('hidden');
    }

    function showSuccess() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('success').classList.remove('hidden');
    }

    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    async function sendAuthResult(result) {
      console.log('Sending auth result:', JSON.stringify(result));
      try {
        const resp = await fetch('/auth-callback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(result),
        });
        console.log('Auth callback response:', resp.status);
      } catch (e) {
        console.error('Failed to send auth result:', e);
        document.getElementById('loading-text').textContent = 'Error: ' + e.message;
      }
    }

    async function createPrivyClient(skipInit = false) {
      const module = await import('https://esm.sh/@privy-io/js-sdk-core@0.58.5');
      const PrivyClient = module.default;
      const { LocalStorage } = module;

      const config = {
        appId: PRIVY_APP_ID,
        storage: new LocalStorage(),
      };
      if (PRIVY_CLIENT_ID) config.clientId = PRIVY_CLIENT_ID;
      const privy = new PrivyClient(config);

      if (!skipInit) {
        try {
          await privy.initialize();
        } catch (initErr) {
          console.log('Privy init (may be expected):', initErr.message);
        }
      }

      return privy;
    }

    async function setupWalletIframe(privy) {
      try {
        const iframeUrl = privy.embeddedWallet.getURL();
        const iframe = document.createElement('iframe');
        iframe.src = iframeUrl;
        iframe.style.display = 'none';
        document.body.appendChild(iframe);

        await new Promise((resolve) => {
          iframe.addEventListener('load', () => {
            privy.setMessagePoster(iframe.contentWindow);
            window.addEventListener('message', (e) => {
              if (e.source === iframe.contentWindow) {
                try { privy.embeddedWallet.onMessage(e.data); } catch (_) {}
              }
            });
            setTimeout(resolve, 1000);
          });
          setTimeout(resolve, 5000);
        });
      } catch (e) {
        console.warn('Embedded wallet iframe setup failed:', e);
      }
    }

    async function handleAuthenticatedUser(privy, user, session) {
      showLoading('Setting up your wallet...');

      let embeddedWallet = (user.linked_accounts || user.linkedAccounts)?.find(
        a => a.type === 'wallet' && (a.walletClientType === 'privy' || a.wallet_client_type === 'privy')
      );
      let walletAddress = embeddedWallet?.address || null;

      // Create embedded wallet if user doesn't have one yet
      if (!walletAddress) {
        try {
          await setupWalletIframe(privy);
          const result = await privy.embeddedWallet.create({});
          embeddedWallet = (result.user.linked_accounts || result.user.linkedAccounts)?.find(
            a => a.type === 'wallet' && (a.walletClientType === 'privy' || a.wallet_client_type === 'privy')
          );
          walletAddress = embeddedWallet?.address || null;
        } catch (e) {
          console.error('Failed to create embedded wallet:', e);
        }
      }

      let authToken = session?.accessToken || session?.access_token || null;
      if (!authToken) {
        try { authToken = await privy.getAccessToken(); } catch (_) {}
      }

      // Sign master key message for personal server key derivation
      let masterKeySignature = null;
      if (walletAddress) {
        try {
          showLoading('Signing master key...');
          await setupWalletIframe(privy);
          const provider = await privy.embeddedWallet.getProvider();
          // personal_sign expects hex-encoded message
          const msgHex = '0x' + Array.from(new TextEncoder().encode('vana-master-key-v1')).map(b => b.toString(16).padStart(2, '0')).join('');
          masterKeySignature = await provider.request({
            method: 'personal_sign',
            params: [msgHex, walletAddress],
          });
          console.log('[AUTH] Master key signed:', masterKeySignature?.substring(0, 20) + '...');
        } catch (e) {
          console.warn('[AUTH] Master key signing failed (non-fatal):', e.message || e);
        }
      }

      await sendAuthResult({
        success: true,
        user: {
          id: user.id,
          email: user.email?.address
            || (user.linked_accounts || user.linkedAccounts)?.find(a => a.type === 'email')?.address
            || (user.linked_accounts || user.linkedAccounts)?.find(a => a.type === 'google_oauth')?.email
            || (user.linked_accounts || user.linkedAccounts)?.find(a => a.type === 'apple_oauth')?.email
            || null,
        },
        walletAddress,
        authToken,
        masterKeySignature,
      });

      showSuccess();
      // Try to close the tab; browsers block this for non-JS-opened tabs,
      // so the user may need to close it manually
      setTimeout(() => { try { window.close(); } catch (_) {} }, 1500);
    }

    async function init() {
      try {
        // Check if this is an OAuth callback (returning from Google redirect)
        const queryParams = new URLSearchParams(window.location.search);
        const oauthCode = queryParams.get('privy_oauth_code');
        const oauthState = queryParams.get('privy_oauth_state');

        // Clear previous session on fresh visits (not OAuth callbacks)
        if (!oauthCode) {
          localStorage.clear();
        }

        // On OAuth callbacks skip initialize() — partial state causes "Missing refresh token".
        // On fresh visits, call initialize() so the SDK is ready for sendCode/generateURL.
        const privy = await createPrivyClient(!!oauthCode);

        // Ensure no stale session lingers (initialize may have restored one from a race)
        if (!oauthCode) {
          try { await privy.auth.logout(); } catch (_) {}
        }

        if (oauthCode && oauthState) {
          showLoading('Completing sign-in...');
          console.log('[AUTH] OAuth callback detected, code:', oauthCode.substring(0, 8) + '...');
          console.log('[AUTH] localStorage keys:', Object.keys(localStorage));
          try {
            console.log('[AUTH] Calling loginWithCode...');
            const session = await privy.auth.oauth.loginWithCode(oauthCode, oauthState);
            console.log('[AUTH] loginWithCode succeeded, session keys:', Object.keys(session || {}));
            const user = session.user;
            await handleAuthenticatedUser(privy, user, session);
            return;
          } catch (e) {
            console.error('[AUTH] OAuth callback error:', e);
            console.error('[AUTH] Error stack:', e.stack);
            showError(e.message || 'Failed to complete Google sign-in');
          }
        }

        // Only check existing session if returning from OAuth redirect
        // (otherwise we'd skip the login form with a stale session)

        // Show login form
        showLoginForm();

        const container = document.getElementById('privy-container');
        container.innerHTML = `
          <div class="email-row">
            <svg class="mail-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
            </svg>
            <input type="email" id="email" placeholder="jane@example.com" />
            <button id="email-btn" class="submit-btn" title="Send sign-in code">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </button>
          </div>

          <button id="google-btn" class="oauth-btn">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Google
          </button>

          <button id="apple-btn" class="oauth-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.52-3.23 0-1.44.62-2.2.44-3.06-.4C3.79 16.17 4.36 9.63 8.7 9.36c1.28.07 2.17.72 2.92.72.75 0 2.15-.89 3.63-.76 1.24.05 2.36.5 3.03 1.53-2.78 1.68-2.12 5.38.77 6.41-.6 1.58-1.38 3.14-2.99 3.02h-.01zM12.05 9.3c-.16-2.08 1.54-3.87 3.53-4.05.27 2.29-2.05 4.01-3.53 4.05z"/>
            </svg>
            Apple
          </button>

          <div id="code-section" class="code-section hidden">
            <label for="code">Enter verification code</label>
            <input type="text" id="code" placeholder="------" maxlength="6" />
            <button id="verify-btn" class="verify-btn">Verify code</button>
          </div>

          <div class="footer">
            By creating an account, you agree to our<br>
            <a href="https://www.vana.org/terms" target="_blank">Terms of Service</a> and <a href="https://www.vana.org/privacy-policy" target="_blank">Privacy Policy</a>.
          </div>
        `;

        let currentEmail = '';

        // Google login — generates OAuth URL and redirects
        document.getElementById('google-btn').addEventListener('click', async () => {
          try {
            document.getElementById('google-btn').disabled = true;
            // Clear any stale session to avoid "Missing refresh token"
            try { await privy.auth.logout(); } catch (_) {}
            const redirectURI = window.location.origin + window.location.pathname;
            const result = await privy.auth.oauth.generateURL('google', redirectURI);
            const url = typeof result === 'string' ? result : result.url || result;
            window.location.href = url;
          } catch (e) {
            console.error('Google login error:', e);
            showError(e.message || 'Failed to sign in with Google');
            document.getElementById('google-btn').disabled = false;
          }
        });

        // Apple login
        document.getElementById('apple-btn').addEventListener('click', async () => {
          try {
            document.getElementById('apple-btn').disabled = true;
            try { await privy.auth.logout(); } catch (_) {}
            const redirectURI = window.location.origin + window.location.pathname;
            const result = await privy.auth.oauth.generateURL('apple', redirectURI);
            const url = typeof result === 'string' ? result : result.url || result;
            window.location.href = url;
          } catch (e) {
            console.error('Apple login error:', e);
            showError(e.message || 'Failed to sign in with Apple');
            document.getElementById('apple-btn').disabled = false;
          }
        });

        // Email - send code (click or Enter key)
        const submitEmail = async () => {
          const email = document.getElementById('email').value.trim();
          if (!email) {
            showError('Please enter your email');
            return;
          }

          try {
            document.getElementById('email-btn').disabled = true;
            currentEmail = email;
            await privy.auth.email.sendCode(email);
            document.getElementById('code-section').classList.remove('hidden');
            document.querySelector('.email-row').classList.add('hidden');
          } catch (e) {
            console.error('Send code error:', e);
            showError(e.message || 'Failed to send code');
          } finally {
            document.getElementById('email-btn').disabled = false;
          }
        };
        document.getElementById('email-btn').addEventListener('click', submitEmail);
        document.getElementById('email').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') submitEmail();
        });

        // Email - verify code
        document.getElementById('verify-btn').addEventListener('click', async () => {
          const code = document.getElementById('code').value.trim();
          if (!code) {
            showError('Please enter the verification code');
            return;
          }

          try {
            document.getElementById('verify-btn').disabled = true;
            document.getElementById('verify-btn').textContent = 'Verifying...';
            const session = await privy.auth.email.loginWithCode(currentEmail, code);
            const user = session.user;
            await handleAuthenticatedUser(privy, user, session);
          } catch (e) {
            console.error('Verify code error:', e);
            showError(e.message || 'Invalid code');
            document.getElementById('verify-btn').disabled = false;
            document.getElementById('verify-btn').textContent = 'Verify code';
          }
        });

      } catch (error) {
        console.error('Privy initialization error:', error);
        showLoginForm();
        showError('Failed to initialize authentication: ' + error.message);
      }
    }

    init();
  </script>
</body>
</html>
